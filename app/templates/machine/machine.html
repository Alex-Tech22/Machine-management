{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_machine.css') }}">
{% endblock %}

{% block title %}Machine - Mayekawa{% endblock %}

{% block content %}
<section class="machine-info">
    <div class="machine-img">
        <img src="{{ url_for('static', filename='/' + machine.qrcode) }}" alt="QR Code de la machine">
    </div>
    <div class="machine-details">
        <h2>{{ machine.machine_name }}</h2>
        <p><strong>Num√©ro de s√©rie :</strong> {{ machine.serial_number }}</p>
        <p><strong>Date de mise en service :</strong> {{ machine.production_date }}</p>
        <p><strong>Mod√®le :</strong> {{ machine.modele_machine.model_name }}</p>
    </div>
</section>

<!-- Onglets -->
<div class="tabs">
    <button class="tab-button active" onclick="openTab(event, 'reglages')">R√©glages</button>
    <button class="tab-button" onclick="openTab(event, 'manuel')">Manuel</button>
    <button class="tab-button" onclick="openTab(event, 'historique')">Historique</button>
</div>

<!-- Contenu des cat√©gories -->
<div id="reglages" class="tab-content active">
    <h3>R√©glages</h3>
    {% for station_name, settings in settings_by_station.items() %}
        <h4>{{ station_name }}</h4>
        {% for setting in settings %}
            <div class="setting-block">
                {% if setting.picture_link %}
                <img src="{{ url_for('static', filename='images/settings/' ~ setting.picture_link) }}"
                    class="setting-img"
                    alt="Image r√©glage"
                    onclick="openImageModal(this.src)">
                {% endif %}
                
                <div class="setting-details">
                    <p><strong>{{ setting.setting_name }}</strong> ({{ setting.setting_type }})</p>
                    {% if setting.setting_type == 'Num' %}
                        {% for val in setting.default_values %}
                            <p><strong>{{ val.name or "Nom inconnu" }} :</strong> {{ val.default_value }}</p>
                        {% endfor %}
                    {% elif setting.setting_type == 'Tab' %}
                        <table class="table-setting">
                            <thead>
                                <tr>
                                    <th>ST.</th>
                                    {% for col in column_labels %}
                                        <th>{{ col }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row_label in row_labels %}
                                    {% set row_index = loop.index0 %}
                                    <tr>
                                        <td>{{ row_label }}</td>
                                        {% for col_index in range(column_labels | length) %}
                                            <td>
                                                {{ value_map[(setting.ID_settings, row_index, col_index)] if (setting.ID_settings, row_index, col_index) in value_map else '' }}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>

<div id="manuel" class="tab-content">
    <h3>Manuel</h3>
    {% if machine.manual %}
        <p>Version : {{ machine.manual.manual_version }}</p>
        <p><a href="{{ machine.manual.manual_link }}" target="_blank">üìÑ T√©l√©charger le manuel</a></p>
    {% else %}
        <p>Aucun manuel disponible.</p>
    {% endif %}
</div>

<div id="historique" class="tab-content">
    <h3>Historique</h3>
    <table>
        <tr>
            <th>Date</th>
            <th>Technicien</th>
            <th>Remarque</th>
        </tr>
        {% for entry in machine.history %}
            <tr>
                <td>{{ entry.revisions_date }}</td>
                <td>{{ entry.tech_name }}</td>
                <td>{{ entry.remarks }}</td>
            </tr>
        {% endfor %}
    </table>
</div>

<!-- Modal pour l‚Äôagrandissement d‚Äôimage -->
<div id="imageModal" class="modal" onclick="closeImageModal()">
    <span class="close">&times;</span>
    <img class="modal-content" id="modal-img">
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/machine.js') }}"></script>
{% endblock %}
